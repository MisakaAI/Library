# 视频编码

## 视频容器

容器（container）可以粗略地理解为某种扩展名类型的视频文件。
比如 MP4 是一种容器，MKV 是另一种容器。
常用的容器有：mp4、mkv、flv、avi等。

## 码率

视频的码率（Bit Rate），也称为比特率或数据速率，是指视频文件中每秒传输的比特数。
通常用来衡量视频的数据传输速度或压缩质量。
码率越高，视频的质量越高，但文件大小也越大，传输所需的带宽也越大。

在数字视频中，视频文件通常通过编码来压缩以减小文件大小，从而更好地适应存储和传输的需求。
码率是编码过程中一个重要的参数，它决定了视频文件的压缩率和质量。
较低的码率通常会导致更高的压缩率，但视频质量可能会下降，因为更多的数据被丢弃。
较高的码率可以提供更高的视频质量，但会占用更多的存储空间和传输带宽。

常见的视频码率单位有比特/秒（bps）、千比特/秒（kbps）、兆比特/秒（Mbps）和千兆比特/秒（Gbps）。
例如，一个视频文件的码率为2 Mbps，表示该文件在每秒钟传输2兆比特的数据量。
码率的选择需要根据具体的应用场景和需求进行权衡，以达到最佳的视频质量和传输效果。

## 音频采样率

音频采样率，又称为采样频率，是指在数字音频处理中，对模拟声音信号进行采样的频率，即每秒钟采集的样本数。它通常以赫兹（Hz）为单位表示。

在数字音频中，模拟声音信号经过模数转换（A/D 转换）处理，转换成数字信号，即由连续的模拟信号转换为离散的数字信号。音频采样率决定了每秒钟采集的样本数，采样率越高，表示每秒钟记录的样本数越多，数字音频的精度越高。

常见的音频采样率包括 44.1 kHz、48 kHz、96 kHz 等。其中，44.1 kHz 是音频 CD 标准的采样率，48 kHz 是广泛应用于数字音视频中的常见采样率，而 96 kHz 则通常在高级音频处理和专业音乐录音中使用。

音频采样率的选择通常需要考虑到音频信号的频率范围和音频处理的需求。较高的采样率可以更好地保留高频音频信息，但也会增加存储和处理的开销。因此，在选择音频采样率时，需要权衡音频质量和资源开销之间的平衡。

## 常用的视频编码格式

- [H.264/AVC](https://trac.ffmpeg.org/wiki/Encode/H.264)
是上一代最广为使用的视频编码格式，始于 2003 年，当之无愧的一代霸主。
在 FFmpeg 中可由 `libx264` 编码器支持。
也有基于 NVIDIA 显卡的 H.264 编码器 `NVENC` 。
- [H.265/HEVC](https://trac.ffmpeg.org/wiki/Encode/H.265)
是 H.264 的接任者，于 2013 年正式面世。
它在同等视频质量下提供了相比 H.264 而言可达 50% 的体积缩减。
`libx265` 编码器对该编码格式提供了支持。
- [VP9](https://trac.ffmpeg.org/wiki/Encode/VP9)
经历了从 VP3 起漫长的版本迭代，VP 系列解码器的开发公司 On2 被谷歌收购。
谷歌在 2013 年左右推出了取代上一代 VP8 编码的 VP9。其编码器为 `libvpx`。
主要为旗下的互联网视频平台 Youtube 所采用。
- [AV1](https://trac.ffmpeg.org/wiki/Encode/AV1) (AOMedia Video 1) 
H.265 的免版税竞争者，极大地基于 VP9 的技术，并在 VP9 的基础上提供了惊人的压缩比率。
其开发联盟由诸多互联网公司支持，并受到主流浏览器 Chrome 与 Firefox 的积极推动。
它在 FFmpeg 中由 `libaom-av1` 编码器对该编码格式提供支持。

## 常用的音频编码格式

- [MP3](https://trac.ffmpeg.org/wiki/Encode/MP3)
时至今日仍最流行的有损编码格式。
编码器 `libmp3lame`。
- [AAC](https://trac.ffmpeg.org/wiki/Encode/AAC)
是 MP3 的接任者，常常作为视频容器 MKV 选用的音频格式，而其作为音频时的容器则通常是是 `m4a`。
编码器有 FFmpeg 原生提供的、针对低码率音频（AAC LC）的 `aac` 编码器；
此外，需要制作高质量 AAC 时（HE-AAC）可以使用 `libfdk_aac` 编码器。
- FLAC
是较常用的无损音频格式，编码器为 `flac`。
- AC3
杜比数字格式，编码器 `ac3` (Dolby Digital) 或者 `eac3` (Dolby Digital Plus)。
- PCM
是 WAV 容器内包含的最常见音频编码格式。
FFmpeg 默认使用 `pcm_s16le` 编码器来处理 PCM 输出。

## 视频压制

视频的压制主要有 CRF（Constant Rate Factor）与二压（2Pass）两种常用的方法。
如果要严格限制视频码率，也会考虑使用定限码率压制。

### 恒定率系数（CRF）

在编码器 `libx264/libx265` 中（vp9等其他编码器中的情形并不同） ，CRF 指定一个 0~51 的数值作为视频质量标准值。
（FFmpeg 中，libx264 默认 23，常用范围是 17~28；libx265 默认 28）
CRF 的数值越小，恒定率系数越好，压缩率也越低。
恒定律系数的视频码率是根据画面动态调整的，与恒定码率（CBR）恰好是对立的。

CRF 为 0 表示无损，51 表示 FFmpeg 所能达到的最差效果。

如果设置一个小于默认值 23 的值，那么输出视频的画面会（从视觉观感上）保留较好的效果，但同时文件的体积也较大。
如果设置一个大于 23 的值，那么输出的视频大小会被压缩，但会在画面观感上有一定损失。

对于 H.264 编码，CRF 在 17 左右时，输出的视频损失就非常小了，因此选择比 17 更小的 CRF 意义不大。
类似地，CRF 如果低于 28，其效果相比于原视频可能就会出现明显的损失，因此通常也不建议选择大于 28 的数值。

CRF 的压制中还有一个参数，称为预案 `-preset` 。
较慢的预案能够更好地发挥压制的效果，按压制后质量从低到高分为 `ultrafast` `superfast` `veryfast` `faster` `fast` `medium` `slow` `slower` `veryslow` 这9种。
预案越慢，压缩效果（指视频质量与文件体积之比）越好，或者说同等视频质量下输出文件的体积越小。

### 二压（2Pass）

通常只在强制要求文件大小时使用二压。

例如需要将一个10分钟（600秒）长的视频压制到200MB，并保持音频码率在 128 kbps。
首先计算压制后视频流的比特率值。1 MB = 8192 kbit。
下式的第一项即为总文件的比特率值，减去第二项音频流的比特率值，就得到了视频流的比特率值：

> 200 × 8192 = 1638400(kbit)1
> 1638400(kbit) ÷ 600(s) ≈ 2730(kbit/s)
> 2730-128 = 2602(kbit/s)

### 定限码率（Limited bitrate）

定限码率压制并不考虑文件大小，而是只限制文件码率。
多见于网络上传视频（或者流媒体传输受到网络条件限制）的场合。

## 参考文献

- [ChatGPT](https://chat.openai.com/?model=text-davinci-002-render-sha)
- [FFmpeg 教程](https://wklchris.github.io/blog/FFmpeg/Intro.html#codec-format)